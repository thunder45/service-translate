# TTS Server (WebSocket Server)

Real-time translation broadcasting server with optional AWS Polly TTS generation.

## Features

- **WebSocket Communication**: Socket.IO for real-time bidirectional messaging
- **Session Management**: Create and manage translation sessions
- **AWS Polly TTS**: Optional server-side text-to-speech generation
- **Audio Serving**: HTTP endpoints for audio file delivery
- **Security**: Rate limiting, authentication, and session validation
- **Monitoring**: Comprehensive logging and health checks

## Architecture

```
Capture App → TTS Server → PWA Clients
                  ↓
            AWS Polly (optional)
                  ↓
            Audio Cache
```

## Quick Start

### 1. Install Dependencies
```bash
npm install
```

### 2. Configure TTS
```bash
./setup-tts.sh  # Interactive setup
# Or manually: cp .env.example .env && nano .env
```

### 3. Start Server
```bash
npm start
```

## Configuration

### Environment Variables

```bash
# Server
PORT=3001

# TTS (Optional)
ENABLE_TTS=false                    # Set to 'true' to enable AWS Polly
AWS_REGION=us-east-1
AWS_IDENTITY_POOL_ID=               # Cognito Identity Pool ID
AWS_USER_POOL_ID=                   # Cognito User Pool ID
AWS_JWT_TOKEN=                      # JWT token (optional)

# Security
ENABLE_AUTH=false
AUTO_GENERATE_SESSION_IDS=false     # Accept client-provided session IDs
SESSION_TIMEOUT_MINUTES=480

# Rate Limiting
WEBSOCKET_RATE_LIMIT_PER_SECOND=10
POLLY_RATE_LIMIT_PER_MINUTE=60
MAX_CLIENTS_PER_SESSION=50
```

### TTS Modes

#### Disabled (Default)
```bash
ENABLE_TTS=false
```
- Clients receive text-only translations
- Clients can use local Web Speech API TTS
- Zero AWS Polly costs

#### Enabled
```bash
ENABLE_TTS=true
AWS_REGION=us-east-1
AWS_IDENTITY_POOL_ID=us-east-1:xxx
AWS_USER_POOL_ID=us-east-1_xxx
AWS_JWT_TOKEN=eyJxxx...
```
- Server generates audio using AWS Polly
- Clients receive high-quality audio URLs
- Costs apply per character

## API Reference

### WebSocket Events

#### From Capture App

**start-session**
```typescript
{
  sessionId: string;
  config: {
    enabledLanguages: string[];
    ttsMode: 'neural' | 'standard' | 'local' | 'disabled';
    audioQuality: 'high' | 'medium' | 'low';
  }
}
```

**broadcast-translation**
```typescript
{
  sessionId: string;
  original: string;
  translations: {
    en: string;
    es: string;
    fr: string;
    de: string;
    it: string;
  };
  generateTTS: boolean;      // Request TTS generation
  voiceType: 'neural' | 'standard';
}
```

#### From PWA Clients

**join-session**
```typescript
{
  sessionId: string;
  language: string;
  clientInfo: {
    userAgent: string;
    audioCapabilities: {
      localTTSLanguages: string[];
    }
  }
}
```

#### To Clients

**translation**
```typescript
{
  type: 'translation';
  sessionId: string;
  original: string;
  text: string;
  language: string;
  timestamp: number;
  audioUrl: string | null;    // null if TTS disabled/failed
  audioMetadata: {
    audioId: string;
    duration: number;
    format: string;
    voiceType: string;
    size: number;
  } | null;
  ttsAvailable: boolean;
}
```

### HTTP Endpoints

**GET /health**
```bash
curl http://localhost:3001/health
```
Returns server health status

**GET /audio/:filename**
```bash
curl http://localhost:3001/audio/abc123.mp3
```
Serves audio files generated by Polly

## Development

### Run in Development Mode
```bash
npm run dev
```

### Run Tests
```bash
npm test
```

### Build
```bash
npm run build
```

## Troubleshooting

### TTS Not Working
1. Check `ENABLE_TTS=true` in .env
2. Verify AWS credentials are correct
3. Check JWT token is valid (not expired)
4. Review server logs for Polly errors

### Clients Not Receiving Audio
1. Verify TTS is enabled on server
2. Check capture app is sending `generateTTS: true`
3. Confirm audio files are being created in `audio-cache/`
4. Test audio URL directly in browser

### Connection Issues
1. Check server is running on correct port
2. Verify firewall allows WebSocket connections
3. Confirm capture app has correct server URL
4. Review CORS settings if needed

## Cost Optimization

### TTS Costs
- **Neural voices**: $16 per 1M characters
- **Standard voices**: $4 per 1M characters
- **Typical service**: ~225K characters = $0.90-$3.60

### Reduce Costs
1. Use standard voices instead of neural
2. Disable TTS and use local client TTS
3. Enable TTS only for specific languages
4. Set rate limits to prevent abuse

## Security

### Best Practices
1. Enable authentication for production
2. Use secure session IDs
3. Set appropriate rate limits
4. Rotate JWT tokens regularly
5. Monitor for unusual activity

### Rate Limiting
- WebSocket messages: 10/second per client
- Polly requests: 60/minute per client
- Max clients per session: 50

## Monitoring

### Health Check
```bash
curl http://localhost:3001/health
```

### Logs
Server logs include:
- Connection events
- Session lifecycle
- TTS generation requests
- Error tracking
- Performance metrics

## Production Deployment

### Recommended Setup
1. Run on dedicated machine or VM
2. Use process manager (PM2, systemd)
3. Enable authentication
4. Configure firewall rules
5. Set up monitoring/alerting
6. Regular log rotation

### Example PM2 Config
```javascript
module.exports = {
  apps: [{
    name: 'tts-server',
    script: './dist/server.js',
    instances: 1,
    autorestart: true,
    watch: false,
    max_memory_restart: '1G',
    env: {
      NODE_ENV: 'production',
      PORT: 3001
    }
  }]
}
```

## Support

For issues or questions:
1. Check server logs
2. Review configuration
3. Test with minimal setup
4. Check AWS service status
5. Verify network connectivity
