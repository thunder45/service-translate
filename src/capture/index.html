<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Translate - Local Audio Processing</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .login-form {
            display: grid;
            gap: 15px;
            max-width: 400px;
            margin: 0 auto;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        label {
            font-weight: 500;
            font-size: 14px;
        }
        
        input, button, select {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
        }
        
        input, select {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
        }
        
        input[type="range"] {
            background: rgba(255, 255, 255, 0.3);
            height: 6px;
            padding: 0;
        }
        
        #gainValue {
            margin-left: 10px;
            font-weight: 500;
        }
        
        button {
            background: #4CAF50;
            color: white;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #45a049;
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .streaming-controls {
            text-align: center;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 30px;
        }
        
        .vu-meter {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        
        .vu-meter-label {
            font-size: 12px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .vu-meter-bars {
            display: flex;
            gap: 2px;
            height: 60px;
            align-items: flex-end;
        }
        
        .vu-bar {
            width: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            transition: all 0.1s ease;
        }
        
        .vu-bar.active {
            background: linear-gradient(to top, #4CAF50 0%, #FFC107 70%, #f44336 100%);
        }
        
        .start-btn {
            background: #2196F3;
            font-size: 16px;
            padding: 15px 30px;
        }
        
        .stop-btn {
            background: #f44336;
        }
        
        .results-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .transcription-panel {
            min-height: 200px;
        }
        
        .translation-panel {
            min-height: 300px;
        }
        
        .translation-tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .tab-button {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            padding: 10px 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .tab-button.active {
            color: white;
            border-bottom-color: #FFD700;
        }
        
        .tab-button:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .tab-content {
            display: none;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 15px;
            min-height: 200px;
            max-height: 300px;
            font-size: 16px;
            line-height: 1.5;
            overflow-y: auto;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .panel-header {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .text-content {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 15px;
            min-height: 200px;
            max-height: 300px;
            font-size: 16px;
            line-height: 1.5;
            overflow-y: auto;
        }
        
        .translation-item {
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
        }
        
        .translation-lang {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 5px;
            color: #FFD700;
        }
        
        .status {
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .status.success {
            background: rgba(76, 175, 80, 0.3);
        }
        
        .status.error {
            background: rgba(244, 67, 54, 0.3);
        }
        
        .status.info {
            background: rgba(33, 150, 243, 0.3);
        }
        
        .hidden {
            display: none;
        }
        
        .config-btn, .logout-btn {
            position: absolute;
            top: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 15px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .logout-btn {
            right: 20px;
        }
        
        .config-btn {
            right: 140px;
        }
    </style>
</head>
<body>
    <div class="container">
        <button class="config-btn" onclick="showConfig()">‚öôÔ∏è Configuration</button>
        <button class="logout-btn hidden" onclick="logout()" id="logout-btn">üö™‚û°Ô∏è Logout</button>
        
        <div class="header">
            <h1>üé§ Service Translate</h1>
            <p>Local Real-Time Audio Translation</p>
        </div>

        <!-- Configuration Panel -->
        <div id="config-panel" class="card hidden">
            <h2>Configuration</h2>
            <div class="translation-tabs">
                <button class="tab-button active" onclick="switchConfigTab('connection')">üîó Connection</button>
                <button class="tab-button" onclick="switchConfigTab('audio')">üé§ Audio</button>
            </div>
            
            <div class="tab-content active" id="config-connection">
                <div class="login-form">
                    <div class="form-group">
                        <label>WebSocket Endpoint:</label>
                        <input type="text" id="endpoint" placeholder="wss://...">
                    </div>
                    <div class="form-group">
                        <label>User Pool ID:</label>
                        <input type="text" id="userPoolId" placeholder="us-east-1_...">
                    </div>
                    <div class="form-group">
                        <label>Client ID:</label>
                        <input type="text" id="clientId" placeholder="...">
                    </div>
                    <div class="form-group">
                        <label>Identity Pool ID:</label>
                        <input type="text" id="identityPoolId" placeholder="us-east-1:...">
                    </div>
                    <div class="form-group">
                        <label>Region:</label>
                        <input type="text" id="region" value="us-east-1">
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="config-audio">
                <div class="login-form">
                    <div class="form-group">
                        <label>Input Device:</label>
                        <select id="inputDevice">
                            <option value="default">Default System Input</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Sample Rate:</label>
                        <select id="sampleRate">
                            <option value="16000" selected>16 kHz (Recommended)</option>
                            <option value="8000">8 kHz</option>
                            <option value="22050">22.05 kHz</option>
                            <option value="44100">44.1 kHz</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Encoding:</label>
                        <select id="encoding">
                            <option value="signed-integer" selected>16-bit PCM (Recommended)</option>
                            <option value="unsigned-integer">8-bit PCM</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Channels:</label>
                        <select id="channels">
                            <option value="1" selected>Mono (Recommended)</option>
                            <option value="2">Stereo</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Input Gain:</label>
                        <input type="range" id="inputGain" min="0" max="200" value="100" step="10">
                        <span id="gainValue">100%</span>
                    </div>
                </div>
            </div>
            
            <button onclick="saveConfig()" style="margin-top: 20px;">Save Configuration</button>
        </div>

        <!-- Login Panel -->
        <div id="login-panel" class="card">
            <h2>Admin Login</h2>
            <div class="login-form">
                <div class="form-group">
                    <label>Username:</label>
                    <input type="text" id="username" placeholder="admin@example.com" onkeypress="handleLoginKeyPress(event)">
                </div>
                <div class="form-group">
                    <label>Password:</label>
                    <input type="password" id="password" onkeypress="handleLoginKeyPress(event)">
                </div>
                <button onclick="login()" id="login-btn">Login</button>
            </div>
        </div>

        <!-- Main Application -->
        <div id="main-app" class="hidden">
            <div id="status" class="status hidden"></div>
            
            <div class="streaming-controls">
                <button class="start-btn" onclick="startStreaming()" id="start-btn">
                    üé§ Start Local Streaming
                </button>
                <button class="stop-btn hidden" onclick="stopStreaming()" id="stop-btn">
                    ‚èπÔ∏è Stop Streaming
                </button>
                
                <div class="vu-meter hidden" id="vu-meter">
                    <div class="vu-meter-label">Audio Level</div>
                    <div class="vu-meter-bars" id="vu-bars">
                        <!-- VU bars will be generated by JavaScript -->
                    </div>
                </div>
            </div>

            <div class="results-container">
                <div class="card translation-panel">
                    <div class="panel-header">üåç Translations</div>
                    <div class="translation-tabs">
                        <button class="tab-button active" onclick="switchTab('en-US')">üá∫üá∏ English</button>
                        <button class="tab-button" onclick="switchTab('es-ES')">üá™üá∏ Spanish</button>
                        <button class="tab-button" onclick="switchTab('fr-FR')">üá´üá∑ French</button>
                        <button class="tab-button" onclick="switchTab('de-DE')">üá©üá™ German</button>
                        <button class="tab-button" onclick="switchTab('it-IT')">üáÆüáπ Italian</button>
                    </div>
                    <div class="tab-content active" id="tab-en-US">
                        English translations will appear here...
                    </div>
                    <div class="tab-content" id="tab-es-ES">
                        Spanish translations will appear here...
                    </div>
                    <div class="tab-content" id="tab-fr-FR">
                        French translations will appear here...
                    </div>
                    <div class="tab-content" id="tab-de-DE">
                        German translations will appear here...
                    </div>
                    <div class="tab-content" id="tab-it-IT">
                        Italian translations will appear here...
                    </div>
                </div>

                <div class="card transcription-panel">
                    <div class="panel-header">üáµüáπ Portuguese (Original)</div>
                    <div class="text-content" id="transcription-content">
                        Waiting for audio...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let isLoggedIn = false;
        let isStreaming = false;
        let activeTab = 'en-US';
        let vuBars = [];

        function initializeVUMeter() {
            const vuBarsContainer = document.getElementById('vu-bars');
            vuBars = [];
            
            // Create 20 VU bars
            for (let i = 0; i < 20; i++) {
                const bar = document.createElement('div');
                bar.className = 'vu-bar';
                bar.style.height = '0%';
                vuBarsContainer.appendChild(bar);
                vuBars.push(bar);
            }
        }

        function updateVUMeter(level) {
            if (!vuBars.length) return;
            
            // Convert level (0-100) to number of active bars
            const activeBars = Math.floor((level / 100) * vuBars.length);
            
            vuBars.forEach((bar, index) => {
                if (index < activeBars) {
                    bar.classList.add('active');
                    bar.style.height = '100%';
                } else {
                    bar.classList.remove('active');
                    bar.style.height = '10%';
                }
            });
        }

        // Initialize VU meter on page load
        document.addEventListener('DOMContentLoaded', initializeVUMeter);

        function handleLoginKeyPress(event) {
            if (event.key === 'Enter') {
                login();
            }
        }

        function switchConfigTab(tabName) {
            // Update active tab button
            document.querySelectorAll('#config-panel .tab-button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update active tab content
            document.querySelectorAll('#config-panel .tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`config-${tabName}`).classList.add('active');
        }

        function switchTab(language) {
            // Update active tab button
            document.querySelectorAll('.translation-panel .tab-button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update active tab content
            document.querySelectorAll('.translation-panel .tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`tab-${language}`).classList.add('active');
            
            activeTab = language;
        }

        // Load configuration on startup
        window.electronAPI.loadConfig().then(config => {
            if (config) {
                // Connection tab
                document.getElementById('endpoint').value = config.endpoint || '';
                document.getElementById('userPoolId').value = config.userPoolId || '';
                document.getElementById('clientId').value = config.clientId || '';
                document.getElementById('identityPoolId').value = config.identityPoolId || '';
                document.getElementById('region').value = config.region || 'us-east-1';
                
                // Audio tab
                document.getElementById('inputDevice').value = config.inputDevice || 'default';
                document.getElementById('sampleRate').value = config.sampleRate || '16000';
                document.getElementById('encoding').value = config.encoding || 'signed-integer';
                document.getElementById('channels').value = config.channels || '1';
                document.getElementById('inputGain').value = config.inputGain || '100';
                updateGainDisplay();
            }
        });

        function updateGainDisplay() {
            const gainSlider = document.getElementById('inputGain');
            const gainValue = document.getElementById('gainValue');
            gainValue.textContent = gainSlider.value + '%';
        }

        // Update gain display when slider changes
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('inputGain').addEventListener('input', updateGainDisplay);
        });

        // Check for stored credentials on startup
        window.electronAPI.checkStoredCredentials().then(result => {
            if (result.success) {
                isLoggedIn = true;
                document.getElementById('username').value = result.username;
                document.getElementById('login-panel').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                document.getElementById('logout-btn').classList.remove('hidden');
                showStatus('Welcome back! Ready for local streaming.', 'success');
            }
        });

        function logout() {
            window.electronAPI.logout().then(() => {
                isLoggedIn = false;
                document.getElementById('main-app').classList.add('hidden');
                document.getElementById('logout-btn').classList.add('hidden');
                document.getElementById('login-panel').classList.remove('hidden');
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                showStatus('Logged out successfully', 'info');
            });
        }

        function showConfig() {
            const panel = document.getElementById('config-panel');
            panel.classList.toggle('hidden');
            
            // Load audio devices when config panel is opened
            if (!panel.classList.contains('hidden')) {
                loadAudioDevices();
            }
        }

        async function loadAudioDevices() {
            try {
                const devices = await window.electronAPI.getAudioDevices();
                const deviceSelect = document.getElementById('inputDevice');
                const currentValue = deviceSelect.value;
                
                // Clear existing options
                deviceSelect.innerHTML = '';
                
                // Add device options
                devices.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.id;
                    option.textContent = device.name;
                    deviceSelect.appendChild(option);
                });
                
                // Restore previous selection if it exists
                if (currentValue && [...deviceSelect.options].some(opt => opt.value === currentValue)) {
                    deviceSelect.value = currentValue;
                }
            } catch (error) {
                console.error('Failed to load audio devices:', error);
            }
        }

        function saveConfig() {
            const config = {
                // Connection settings
                endpoint: document.getElementById('endpoint').value,
                userPoolId: document.getElementById('userPoolId').value,
                clientId: document.getElementById('clientId').value,
                identityPoolId: document.getElementById('identityPoolId').value,
                region: document.getElementById('region').value,
                deviceId: 'macos-capture-local',
                
                // Audio settings
                inputDevice: document.getElementById('inputDevice').value,
                sampleRate: parseInt(document.getElementById('sampleRate').value),
                encoding: document.getElementById('encoding').value,
                channels: parseInt(document.getElementById('channels').value),
                inputGain: parseInt(document.getElementById('inputGain').value)
            };

            window.electronAPI.saveConfig(config).then(() => {
                showStatus('Configuration saved successfully', 'success');
                document.getElementById('config-panel').classList.add('hidden');
            });
        }

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const config = await window.electronAPI.loadConfig();

            if (!config || !config.userPoolId || !config.clientId) {
                showStatus('Please configure the application first', 'error');
                return;
            }

            const loginBtn = document.getElementById('login-btn');
            loginBtn.disabled = true;
            loginBtn.textContent = 'Logging in...';

            try {
                const credentials = {
                    username,
                    password,
                    userPoolId: config.userPoolId,
                    clientId: config.clientId,
                    region: config.region,
                    identityPoolId: config.identityPoolId
                };

                const result = await window.electronAPI.login(credentials);
                
                if (result.success) {
                    isLoggedIn = true;
                    document.getElementById('login-panel').classList.add('hidden');
                    document.getElementById('main-app').classList.remove('hidden');
                    document.getElementById('logout-btn').classList.remove('hidden');
                    showStatus('Login successful! Ready for local streaming.', 'success');
                }
            } catch (error) {
                showStatus(`Login failed: ${error.message}`, 'error');
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Login';
            }
        }

        async function startStreaming() {
            if (!isLoggedIn) {
                showStatus('Please login first', 'error');
                return;
            }

            const startBtn = document.getElementById('start-btn');
            const stopBtn = document.getElementById('stop-btn');

            startBtn.disabled = true;
            startBtn.textContent = 'üé§ Starting...';

            try {
                await window.electronAPI.startLocalStreaming();
                
                isStreaming = true;
                startBtn.classList.add('hidden');
                stopBtn.classList.remove('hidden');
                document.getElementById('vu-meter').classList.remove('hidden');
                
                showStatus('üé§ Local streaming active - Speak into your microphone', 'info');
                
                // Clear previous results
                document.getElementById('transcription-content').textContent = 'Listening...';
                document.getElementById('tab-en-US').textContent = 'Waiting for English translations...';
                document.getElementById('tab-es-ES').textContent = 'Waiting for Spanish translations...';
                document.getElementById('tab-fr-FR').textContent = 'Waiting for French translations...';
                document.getElementById('tab-de-DE').textContent = 'Waiting for German translations...';
                document.getElementById('tab-it-IT').textContent = 'Waiting for Italian translations...';
                
            } catch (error) {
                showStatus(`Failed to start streaming: ${error.message}`, 'error');
                startBtn.disabled = false;
                startBtn.textContent = 'üé§ Start Local Streaming';
            }
        }

        async function stopStreaming() {
            const startBtn = document.getElementById('start-btn');
            const stopBtn = document.getElementById('stop-btn');

            try {
                await window.electronAPI.stopLocalStreaming();
                
                isStreaming = false;
                stopBtn.classList.add('hidden');
                startBtn.classList.remove('hidden');
                startBtn.disabled = false;
                startBtn.textContent = 'üé§ Start Local Streaming';
                document.getElementById('vu-meter').classList.add('hidden');
                
                showStatus('Streaming stopped', 'info');
                
            } catch (error) {
                showStatus(`Failed to stop streaming: ${error.message}`, 'error');
            }
        }

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.classList.remove('hidden');
            
            setTimeout(() => {
                status.classList.add('hidden');
            }, 5000);
        }

        // Handle transcription results
        window.electronAPI.onTranscription((result) => {
            const content = document.getElementById('transcription-content');
            if (result.isPartial) {
                content.innerHTML = content.innerHTML.split('<br><em>')[0] + '<br><em>' + result.text + '</em>';
            } else {
                content.innerHTML = content.innerHTML.replace(/<br><em>.*<\/em>/, '') + '<br>' + result.text;
            }
            content.scrollTop = content.scrollHeight;
        });

        // Handle translation results
        window.electronAPI.onTranslation((result) => {
            result.translations.forEach(translation => {
                const tabContent = document.getElementById(`tab-${translation.targetLanguage}`);
                if (tabContent) {
                    const translationItem = `<div style="margin-bottom: 15px; padding: 10px; background: rgba(255, 255, 255, 0.1); border-radius: 6px;">
                        ${translation.text}
                    </div>`;
                    tabContent.innerHTML = translationItem + tabContent.innerHTML;
                }
            });
        });

        // Handle streaming errors
        window.electronAPI.onStreamingError((error) => {
            showStatus(`Streaming error: ${error.error}`, 'error');
        });

        // Handle audio level updates
        window.electronAPI.onAudioLevel((level) => {
            updateVUMeter(level);
        });
    </script>
</body>
</html>
