<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Translate - Local Audio Processing</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .login-form {
            display: grid;
            gap: 15px;
            max-width: 400px;
            margin: 0 auto;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        label {
            font-weight: 500;
            font-size: 14px;
        }
        
        input, button, select {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
        }
        
        input, select {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
        }
        
        input[type="range"] {
            background: rgba(255, 255, 255, 0.3);
            height: 6px;
            padding: 0;
        }
        
        #gainValue {
            margin-left: 10px;
            font-weight: 500;
        }
        
        button {
            background: #4CAF50;
            color: white;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #45a049;
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .streaming-controls {
            text-align: center;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 30px;
        }
        
        .vu-meter-vertical {
            width: 6px;
            height: 120px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 3px;
            overflow: hidden;
            position: relative;
            margin-right: 15px;
        }
        
        .vu-fill-vertical {
            width: 100%;
            background: linear-gradient(to top, #4CAF50, #FFC107, #FF5722);
            height: 0%;
            transition: height 0.1s ease;
            position: absolute;
            bottom: 0;
            border-radius: 3px;
        }
        
        .translation-with-vu {
            display: flex;
            align-items: flex-start;
            width: 100%;
        }
        
        .translation-panel {
            flex: 1;
        }
        
        .session-input {
            text-align: center;
        }
        
        .session-input label {
            display: block;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 5px;
        }
        
        .session-input input {
            padding: 8px 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 14px;
            text-align: center;
            width: 200px;
        }
        
        .session-input input:focus {
            outline: none;
            border-color: #2196F3;
            background: rgba(255, 255, 255, 0.15);
        }
        
        .start-btn {
            background: #2196F3;
            font-size: 16px;
            padding: 15px 30px;
        }
        
        .stop-btn {
            background: #f44336;
        }
        
        .results-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .transcription-panel {
            min-height: 200px;
        }
        
        .translation-panel {
            min-height: 300px;
        }
        
        .translation-tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .tab-button {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            padding: 10px 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .tab-button.active {
            color: white;
            border-bottom-color: #FFD700;
        }
        
        .tab-button:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .tab-content {
            display: none;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 15px;
            min-height: 200px;
            max-height: 300px;
            font-size: 16px;
            line-height: 1.5;
            overflow-y: auto;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .panel-header {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .text-content {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 15px;
            min-height: 200px;
            max-height: 300px;
            font-size: 16px;
            line-height: 1.5;
            overflow-y: auto;
        }
        
        .translation-item {
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
        }
        
        .translation-lang {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 5px;
            color: #FFD700;
        }
        
        .status {
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .status.success {
            background: rgba(76, 175, 80, 0.3);
        }
        
        .status.error {
            background: rgba(244, 67, 54, 0.3);
        }
        
        .status.info {
            background: rgba(33, 150, 243, 0.3);
        }
        
        .hidden {
            display: none;
        }
        
        .config-btn, .logout-btn {
            position: absolute;
            top: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 15px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .logout-btn {
            right: 20px;
        }
        
        .config-btn {
            right: 140px;
        }
        
        .cost-warning {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .language-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
        }
        
        .language-checkbox input[type="checkbox"] {
            width: auto;
            margin: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <button class="config-btn" onclick="showConfig()">‚öôÔ∏è Configuration</button>
        <button class="logout-btn hidden" onclick="logout()" id="logout-btn">üö™‚û°Ô∏è Logout</button>
        
        <div class="header">
            <h1>üé§ Service Translate</h1>
            <p>Local Real-Time Audio Translation</p>
        </div>

        <!-- Configuration Panel -->
        <div id="config-panel" class="card hidden">
            <h2>Configuration</h2>
            <div class="translation-tabs">
                <button class="tab-button active" onclick="switchConfigTab('connection')">üîó Connection</button>
                <button class="tab-button" onclick="switchConfigTab('audio')">üé§ Audio</button>
                <button class="tab-button" onclick="switchConfigTab('tts')">üîä TTS & Session</button>
                <button class="tab-button" onclick="switchConfigTab('holyrics')">üì∫ Holyrics</button>
            </div>
            
            <div class="tab-content active" id="config-connection">
                <div class="login-form">
                    <div class="form-group">
                        <label>User Pool ID:</label>
                        <input type="text" id="userPoolId" placeholder="us-east-1_...">
                    </div>
                    <div class="form-group">
                        <label>Client ID:</label>
                        <input type="text" id="clientId" placeholder="...">
                    </div>
                    <div class="form-group">
                        <label>Identity Pool ID:</label>
                        <input type="text" id="identityPoolId" placeholder="us-east-1:...">
                    </div>
                    <div class="form-group">
                        <label>Region:</label>
                        <input type="text" id="region" value="us-east-1">
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="config-audio">
                <div class="login-form">
                    <div class="form-group">
                        <label>Input Device:</label>
                        <select id="inputDevice">
                            <option value="default">Default System Input</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Sample Rate:</label>
                        <select id="sampleRate">
                            <option value="16000" selected>16 kHz (Recommended)</option>
                            <option value="8000">8 kHz</option>
                            <option value="22050">22.05 kHz</option>
                            <option value="44100">44.1 kHz</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Encoding:</label>
                        <select id="encoding">
                            <option value="signed-integer" selected>16-bit PCM (Recommended)</option>
                            <option value="unsigned-integer">8-bit PCM</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Channels:</label>
                        <select id="channels">
                            <option value="1" selected>Mono (Recommended)</option>
                            <option value="2">Stereo</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Input Gain:</label>
                        <input type="range" id="inputGain" min="0" max="200" value="100" step="10">
                        <span id="gainValue">100%</span>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="config-tts">
                <div class="login-form">
                    <div class="form-group">
                        <label>TTS Mode:</label>
                        <select id="ttsMode">
                            <option value="disabled">Disabled (Text Only)</option>
                            <option value="local">Local Device TTS</option>
                            <option value="standard">AWS Polly Standard ($4/1M chars)</option>
                            <option value="neural" selected>AWS Polly Neural ($16/1M chars)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Enabled Languages:</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 5px;">
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="lang-en-US" checked> üá∫üá∏ English
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="lang-es-ES" checked> üá™üá∏ Spanish
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="lang-fr-FR" checked> üá´üá∑ French
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="lang-de-DE" checked> üá©üá™ German
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="lang-it-IT" checked> üáÆüáπ Italian
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>WebSocket Server URL:</label>
                        <input type="text" id="websocketUrl" placeholder="ws://localhost:3001" value="ws://localhost:3001">
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="config-holyrics">
                <div class="login-form">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="holyricsEnabled"> Enable Holyrics Integration
                        </label>
                    </div>
                    <div class="form-group">
                        <label>Holyrics Host:</label>
                        <input type="text" id="holyricsHost" placeholder="192.168.1.100" value="localhost">
                    </div>
                    <div class="form-group">
                        <label>Holyrics Port:</label>
                        <input type="number" id="holyricsPort" placeholder="8080" value="8080">
                    </div>
                    <div class="form-group">
                        <label>API Token:</label>
                        <input type="text" id="holyricsToken" placeholder="your-api-token">
                    </div>
                    <div class="form-group">
                        <label>Display Language:</label>
                        <select id="holyricsLanguage">
                            <option value="pt">Portuguese (Original)</option>
                            <option value="en">English</option>
                            <option value="es">Spanish</option>
                            <option value="fr">French</option>
                            <option value="de">German</option>
                            <option value="it">Italian</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Max Lines on Screen:</label>
                        <input type="number" id="holyricsMaxLines" min="1" max="10" value="3">
                    </div>
                    <div class="form-group">
                        <button onclick="testHolyricsConnection()" style="margin-top: 10px;">üß™ Test Connection</button>
                        <button onclick="clearHolyrics()" style="margin-top: 10px; margin-left: 10px;">üßπ Clear Screen</button>
                    </div>
                </div>
            </div>
            
            <button onclick="saveConfig()" style="margin-top: 20px;">Save Configuration</button>
        </div>

        <!-- Login Panel -->
        <div id="login-panel" class="card">
            <h2>Admin Login</h2>
            <div class="login-form">
                <div class="form-group">
                    <label>Username:</label>
                    <input type="text" id="username" placeholder="admin@example.com" onkeypress="handleLoginKeyPress(event)">
                </div>
                <div class="form-group">
                    <label>Password:</label>
                    <input type="password" id="password" onkeypress="handleLoginKeyPress(event)">
                </div>
                <button onclick="login()" id="login-btn">Login</button>
            </div>
        </div>

        <!-- Main Application -->
        <div id="main-app" class="hidden">
            <div id="status" class="status">Ready</div>
            
            <div class="streaming-controls">
                <div style="display: flex; align-items: center; justify-content: center; gap: 20px;">
                    <div>
                        <button class="start-btn" onclick="startStreaming()" id="start-btn">
                            üé§ Start Local Streaming
                        </button>
                        <button class="stop-btn hidden" onclick="stopStreaming()" id="stop-btn" style="display: none;">
                            ‚èπÔ∏è Stop Streaming
                        </button>
                    </div>
                    
                    <div class="session-input">
                        <label for="session-id">Session ID:</label>
                        <input type="text" id="session-id" placeholder="Enter session ID" value="CHURCH-2025-001">
                    </div>
                </div>
            </div>

            <!-- Cost Tracking and WebSocket Health Panels -->
            <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                <!-- Cost Tracking Panel (2/3) -->
                <div class="card" id="cost-panel" style="flex: 2;">
                    <div style="display: flex; align-items: stretch;">
                        <div class="vu-meter-vertical" id="vu-meter" style="margin-right: 15px;">
                            <div class="vu-fill-vertical" id="vu-fill"></div>
                        </div>
                        
                        <div style="flex: 1;">
                            <div class="panel-header">üí∞ Cost Tracking</div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                                <div style="text-align: center; flex: 1;">
                                    <div style="font-size: 11px; color: rgba(255,255,255,0.7);">Transcribe</div>
                                    <div id="transcribe-cost" style="font-weight: bold; font-size: 14px;">$0.00</div>
                                    <div id="transcribe-usage" style="font-size: 10px; color: rgba(255,255,255,0.6);">0 min</div>
                                </div>
                                <div style="text-align: center; flex: 1;">
                                    <div style="font-size: 11px; color: rgba(255,255,255,0.7);">Translate</div>
                                    <div id="translate-cost" style="font-weight: bold; font-size: 14px;">$0.00</div>
                                    <div id="translate-usage" style="font-size: 10px; color: rgba(255,255,255,0.6);">0 chars</div>
                                </div>
                                <div style="text-align: center; flex: 1;">
                                    <div style="font-size: 11px; color: rgba(255,255,255,0.7);">Polly TTS</div>
                                    <div id="polly-cost" style="font-weight: bold; font-size: 14px;">$0.00</div>
                                    <div id="polly-usage" style="font-size: 10px; color: rgba(255,255,255,0.6);">0 chars</div>
                                </div>
                            </div>
                            <div style="text-align: center; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 15px;">
                                <div style="font-size: 12px; color: rgba(255,255,255,0.8);">Total Cost</div>
                                <div id="total-cost" style="font-size: 20px; font-weight: bold; color: #FFD700;">$0.00</div>
                                <div id="hourly-rate" style="font-size: 10px; color: rgba(255,255,255,0.6);">$0.00/hour</div>
                            </div>
                            <div id="cost-warning" class="status error hidden" style="margin-top: 10px; margin-bottom: 0; font-size: 11px;">
                                Cost rate exceeds $3/hour threshold!
                            </div>
                        </div>
                    </div>
                </div>

                <!-- WebSocket Health Panel (2/3) -->
                <div class="card" id="websocket-panel" style="flex: 2;">
                    <div class="panel-header">üåê WebSocket Health</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: rgba(255,255,255,0.7);">Server Status</div>
                            <div id="ws-server-status" style="font-weight: bold; color: #f44336;">Checking...</div>
                            <div id="ws-server-url" style="font-size: 11px; color: rgba(255,255,255,0.6);">ws://localhost:3001</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: rgba(255,255,255,0.7);">Connected Clients</div>
                            <div id="ws-client-count" style="font-weight: bold;">0</div>
                            <div id="ws-last-activity" style="font-size: 11px; color: rgba(255,255,255,0.6);">No activity</div>
                        </div>
                    </div>
                    <div style="text-align: center; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 15px;">
                        <div style="font-size: 14px; color: rgba(255,255,255,0.8);">Session Status</div>
                        <div id="ws-session-id" style="font-size: 18px; font-weight: bold; color: #FFD700;">No Session</div>
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button onclick="reconnectWebSocket()" style="flex: 1; font-size: 12px; padding: 8px;">üîÑ Reconnect</button>
                            <button onclick="stopWebSocketServer()" style="flex: 1; font-size: 12px; padding: 8px; background: #f44336;">üõë Stop Server</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Session Management Panel -->
            <div class="card hidden" id="session-panel">
                <div class="panel-header">üì° Session Management</div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div>
                        <div style="font-size: 14px; color: rgba(255,255,255,0.8);">Session ID:</div>
                        <div id="current-session-id" style="font-size: 18px; font-weight: bold;">Not Connected</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 14px; color: rgba(255,255,255,0.8);">Connected Clients:</div>
                        <div id="client-count" style="font-size: 18px; font-weight: bold;">0</div>
                    </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="createSession()" id="create-session-btn" style="flex: 1;">üöÄ Create Session</button>
                    <button onclick="endSession()" id="end-session-btn" style="flex: 1; background: #f44336;" class="hidden">üõë End Session</button>
                </div>
                <div id="websocket-status" class="status info hidden" style="margin-top: 15px; margin-bottom: 0;">
                    WebSocket: Disconnected
                </div>
            </div>

            <div class="results-container">
                <div class="card translation-panel">
                    <div class="panel-header">üåç All Languages</div>
                    <div class="translation-tabs">
                        <button class="tab-button active" onclick="switchTab('pt-BR')">üáßüá∑ Portuguese</button>
                        <button class="tab-button" onclick="switchTab('en-US')">üá∫üá∏ English</button>
                        <button class="tab-button" onclick="switchTab('es-ES')">üá™üá∏ Spanish</button>
                        <button class="tab-button" onclick="switchTab('fr-FR')">üá´üá∑ French</button>
                        <button class="tab-button" onclick="switchTab('de-DE')">üá©üá™ German</button>
                        <button class="tab-button" onclick="switchTab('it-IT')">üáÆüáπ Italian</button>
                    </div>
                    <div class="tab-content active" id="tab-pt-BR">
                        Portuguese transcriptions will appear here...
                    </div>
                    <div class="tab-content" id="tab-en-US">
                        English translations will appear here...
                    </div>
                    <div class="tab-content" id="tab-es-ES">
                        Spanish translations will appear here...
                    </div>
                    <div class="tab-content" id="tab-fr-FR">
                        French translations will appear here...
                    </div>
                    <div class="tab-content" id="tab-de-DE">
                        German translations will appear here...
                    </div>
                    <div class="tab-content" id="tab-it-IT">
                        Italian translations will appear here...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let isLoggedIn = false;
        let isStreaming = false;
        let activeTab = 'pt-BR';
        let vuBars = [];

        function initializeVUMeter() {
            // VU meter initialized (vertical bar)
        }

        function updateVUMeter(level) {
            const vuFill = document.getElementById('vu-fill');
            if (!vuFill) return;
            
            // Set height based on level (0-100) for vertical meter
            vuFill.style.height = Math.min(100, Math.max(0, level)) + '%';
        }

        // Initialize VU meter on page load
        document.addEventListener('DOMContentLoaded', initializeVUMeter);

        function handleLoginKeyPress(event) {
            if (event.key === 'Enter') {
                login();
            }
        }

        function switchConfigTab(tabName) {
            // Update active tab button
            document.querySelectorAll('#config-panel .tab-button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update active tab content
            document.querySelectorAll('#config-panel .tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`config-${tabName}`).classList.add('active');
        }

        function switchTab(language) {
            // Update active tab button
            document.querySelectorAll('.translation-panel .tab-button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update active tab content
            document.querySelectorAll('.translation-panel .tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`tab-${language}`).classList.add('active');
            
            activeTab = language;
        }

        // Load configuration on startup
        window.electronAPI.loadConfig().then(config => {
            if (config) {
                // Connection tab
                document.getElementById('userPoolId').value = config.userPoolId || '';
                document.getElementById('clientId').value = config.clientId || '';
                document.getElementById('identityPoolId').value = config.identityPoolId || '';
                document.getElementById('region').value = config.region || 'us-east-1';
                
                // Audio tab
                document.getElementById('inputDevice').value = config.inputDevice || 'default';
                document.getElementById('sampleRate').value = config.sampleRate || '16000';
                document.getElementById('encoding').value = config.encoding || 'signed-integer';
                document.getElementById('channels').value = config.channels || '1';
                document.getElementById('inputGain').value = config.inputGain || '100';
                updateGainDisplay();
                
                // Holyrics tab
                loadHolyricsConfig(config);
                
                // TTS tab
                loadTTSConfig(config);
            }
        });

        function updateGainDisplay() {
            const gainSlider = document.getElementById('inputGain');
            const gainValue = document.getElementById('gainValue');
            gainValue.textContent = gainSlider.value + '%';
        }

        // Update gain display when slider changes
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('inputGain').addEventListener('input', updateGainDisplay);
        });

        // Check for stored credentials on startup
        window.electronAPI.checkStoredCredentials().then(result => {
            if (result.success) {
                isLoggedIn = true;
                document.getElementById('username').value = result.username;
                document.getElementById('login-panel').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                document.getElementById('logout-btn').classList.remove('hidden');
                showStatus('Welcome back! Checking WebSocket server...', 'success');
                
                // Auto-check and start WebSocket server
                checkAndStartWebSocketServer();
            }
        });

        async function checkAndStartWebSocketServer() {
            try {
                // First check if server is already running
                const isRunning = await checkWebSocketServerStatus();
                
                if (isRunning) {
                    updateWebSocketStatus('connected');
                    updateLastActivity('Server already running');
                    showStatus('WebSocket server is already running', 'success');
                    
                    // Try to connect
                    setTimeout(() => {
                        connectToWebSocketServer();
                    }, 1000);
                } else {
                    // Start the server
                    showStatus('Starting WebSocket server...', 'info');
                    updateLastActivity('Starting server...');
                    
                    const result = await window.electronAPI.startWebSocketServer();
                    
                    if (result.success) {
                        updateWebSocketStatus('connected');
                        updateLastActivity('Server started successfully');
                        showStatus('WebSocket server started successfully', 'success');
                        
                        // Connect after server starts
                        setTimeout(() => {
                            connectToWebSocketServer();
                        }, 2000);
                    } else {
                        updateWebSocketStatus('disconnected');
                        updateLastActivity('Server start failed');
                        showStatus(`Failed to start server: ${result.message}`, 'error');
                    }
                }
            } catch (error) {
                console.error('Error checking/starting WebSocket server:', error);
                updateWebSocketStatus('disconnected');
                updateLastActivity('Server check failed');
                showStatus(`Server check failed: ${error.message}`, 'error');
            }
        }

        async function checkWebSocketServerStatus() {
            try {
                // Use HTTP health check instead of WebSocket (server uses Socket.IO, not native WebSocket)
                const response = await fetch('http://localhost:3001/health', {
                    method: 'GET',
                    signal: AbortSignal.timeout(3000)
                });
                return response.ok;
            } catch (error) {
                return false;
            }
        }

        async function connectToWebSocketServer() {
            try {
                const url = document.getElementById('websocketUrl')?.value || 'ws://localhost:3001';
                const sessionId = document.getElementById('session-id')?.value;
                
                if (sessionId) {
                    // Create session if we have a session ID
                    updateSessionId(sessionId);
                    updateLastActivity('Session created');
                }
                
                updateWebSocketStatus('connected');
                updateLastActivity('Connected to server');
                
            } catch (error) {
                console.error('Failed to check WebSocket server:', error);
                return false;
            }
        }

        async function reconnectWebSocket() {
            showStatus('Reconnecting to WebSocket server...', 'info');
            updateLastActivity('Reconnection requested');
            
            try {
                const isRunning = await checkWebSocketServerStatus();
                
                if (isRunning) {
                    connectToWebSocketServer();
                    showStatus('Reconnected to WebSocket server', 'success');
                } else {
                    // Server is not running, try to start it
                    await checkAndStartWebSocketServer();
                }
            } catch (error) {
                console.error('Failed to reconnect:', error);
                showStatus(`Reconnection failed: ${error.message}`, 'error');
            }
        }

        async function stopWebSocketServer() {
            showStatus('Stopping WebSocket server...', 'info');
            updateLastActivity('Server stop requested');
            
            try {
                // This would call a new IPC handler to stop the server
                const result = await window.electronAPI.stopWebSocketServer();
                
                if (result.success) {
                    updateWebSocketStatus('disconnected');
                    updateSessionId('');
                    updateLastActivity('Server stopped');
                    showStatus('WebSocket server stopped', 'success');
                } else {
                    showStatus(`Failed to stop server: ${result.message}`, 'error');
                }
            } catch (error) {
                console.error('Failed to stop server:', error);
                showStatus(`Failed to stop server: ${error.message}`, 'error');
            }
        }

        function logout() {
            window.electronAPI.logout().then(() => {
                isLoggedIn = false;
                document.getElementById('main-app').classList.add('hidden');
                document.getElementById('logout-btn').classList.add('hidden');
                document.getElementById('login-panel').classList.remove('hidden');
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                showStatus('Logged out successfully', 'info');
            });
        }

        function showConfig() {
            const panel = document.getElementById('config-panel');
            panel.classList.toggle('hidden');
            
            // Load audio devices when config panel is opened
            if (!panel.classList.contains('hidden')) {
                loadAudioDevices();
            }
        }

        async function loadAudioDevices() {
            try {
                const devices = await window.electronAPI.getAudioDevices();
                const deviceSelect = document.getElementById('inputDevice');
                const currentValue = deviceSelect.value;
                
                // Clear existing options
                deviceSelect.innerHTML = '';
                
                // Add device options
                devices.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.id;
                    option.textContent = device.name;
                    deviceSelect.appendChild(option);
                });
                
                // Restore previous selection if it exists
                if (currentValue && [...deviceSelect.options].some(opt => opt.value === currentValue)) {
                    deviceSelect.value = currentValue;
                }
            } catch (error) {
                console.error('Failed to load audio devices:', error);
            }
        }

        function saveConfig() {
            const config = {
                // Connection settings
                userPoolId: document.getElementById('userPoolId').value,
                clientId: document.getElementById('clientId').value,
                identityPoolId: document.getElementById('identityPoolId').value,
                region: document.getElementById('region').value,
                deviceId: 'macos-capture-local',
                
                // Audio settings
                inputDevice: document.getElementById('inputDevice').value,
                sampleRate: parseInt(document.getElementById('sampleRate').value),
                encoding: document.getElementById('encoding').value,
                channels: parseInt(document.getElementById('channels').value),
                inputGain: parseInt(document.getElementById('inputGain').value),
                holyrics: {
                    enabled: document.getElementById('holyricsEnabled').checked,
                    host: document.getElementById('holyricsHost').value,
                    port: parseInt(document.getElementById('holyricsPort').value),
                    token: document.getElementById('holyricsToken').value,
                    language: document.getElementById('holyricsLanguage').value,
                    maxLines: parseInt(document.getElementById('holyricsMaxLines').value)
                },
                tts: {
                    mode: document.getElementById('ttsMode').value,
                    enabledLanguages: getEnabledLanguages(),
                    websocketUrl: document.getElementById('websocketUrl').value,
                    sessionId: document.getElementById('session-id').value
                }
            };

            window.electronAPI.saveConfig(config).then(() => {
                showStatus('Configuration saved successfully', 'success');
                document.getElementById('config-panel').classList.add('hidden');
            });
        }

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const config = await window.electronAPI.loadConfig();

            if (!config || !config.userPoolId || !config.clientId) {
                showStatus('Please configure the application first', 'error');
                return;
            }

            const loginBtn = document.getElementById('login-btn');
            loginBtn.disabled = true;
            loginBtn.textContent = 'Logging in...';

            try {
                const credentials = {
                    username,
                    password,
                    userPoolId: config.userPoolId,
                    clientId: config.clientId,
                    region: config.region,
                    identityPoolId: config.identityPoolId
                };

                const result = await window.electronAPI.login(credentials);
                
                if (result.success) {
                    isLoggedIn = true;
                    document.getElementById('login-panel').classList.add('hidden');
                    document.getElementById('main-app').classList.remove('hidden');
                    document.getElementById('logout-btn').classList.remove('hidden');
                    showStatus('Login successful! Checking WebSocket server...', 'success');
                    
                    // Auto-check and start WebSocket server
                    checkAndStartWebSocketServer();
                }
            } catch (error) {
                showStatus(`Login failed: ${error.message}`, 'error');
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Login';
            }
        }

        async function startStreaming() {
            if (!isLoggedIn) {
                showStatus('Please login first', 'error');
                return;
            }

            const startBtn = document.getElementById('start-btn');
            const stopBtn = document.getElementById('stop-btn');

            startBtn.disabled = true;
            startBtn.textContent = 'üé§ Starting...';

            try {
                await window.electronAPI.startLocalStreaming();
                
                isStreaming = true;
                startBtn.classList.add('hidden');
                stopBtn.classList.remove('hidden');
                document.getElementById('vu-meter').classList.remove('hidden');
                
                showStatus('üé§ Local streaming active - Speak into your microphone', 'info');
                
                // Clear previous results
                document.getElementById('tab-pt-BR').textContent = 'Listening...';
                document.getElementById('tab-en-US').textContent = 'Waiting for English translations...';
                document.getElementById('tab-es-ES').textContent = 'Waiting for Spanish translations...';
                document.getElementById('tab-fr-FR').textContent = 'Waiting for French translations...';
                document.getElementById('tab-de-DE').textContent = 'Waiting for German translations...';
                document.getElementById('tab-it-IT').textContent = 'Waiting for Italian translations...';
                
            } catch (error) {
                showStatus(`Failed to start streaming: ${error.message}`, 'error');
                startBtn.disabled = false;
                startBtn.textContent = 'üé§ Start Local Streaming';
            }
        }

        async function stopStreaming() {
            const startBtn = document.getElementById('start-btn');
            const stopBtn = document.getElementById('stop-btn');

            try {
                await window.electronAPI.stopLocalStreaming();
                
                isStreaming = false;
                stopBtn.classList.add('hidden');
                startBtn.classList.remove('hidden');
                startBtn.disabled = false;
                startBtn.textContent = 'üé§ Start Local Streaming';
                document.getElementById('vu-meter').classList.add('hidden');
                
                showStatus('Streaming stopped', 'info');
                
            } catch (error) {
                showStatus(`Failed to stop streaming: ${error.message}`, 'error');
            }
        }

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.classList.remove('hidden');
            
            setTimeout(() => {
                status.classList.add('hidden');
            }, 5000);
        }

        // TTS Configuration Functions
        function loadTTSConfig(config) {
            if (config && config.tts) {
                document.getElementById('ttsMode').value = config.tts.mode || 'neural';
                document.getElementById('websocketUrl').value = config.tts.websocketUrl || 'ws://localhost:3001';
                document.getElementById('session-id').value = config.tts.sessionId || '';
                
                // Load enabled languages
                const enabledLanguages = config.tts.enabledLanguages || ['en-US', 'es-ES', 'fr-FR', 'de-DE', 'it-IT'];
                ['en-US', 'es-ES', 'fr-FR', 'de-DE', 'it-IT'].forEach(lang => {
                    document.getElementById(`lang-${lang}`).checked = enabledLanguages.includes(lang);
                });
            }
        }
        
        function getEnabledLanguages() {
            const languages = [];
            ['en-US', 'es-ES', 'fr-FR', 'de-DE', 'it-IT'].forEach(lang => {
                if (document.getElementById(`lang-${lang}`).checked) {
                    languages.push(lang);
                }
            });
            return languages;
        }
        
        function generateSessionId() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hour = String(now.getHours()).padStart(2, '0');
            const minute = String(now.getMinutes()).padStart(2, '0');
            
            const sessionId = `CHURCH-${year}${month}${day}-${hour}${minute}`;
            document.getElementById('sessionId').value = sessionId;
            showStatus(`Generated session ID: ${sessionId}`, 'success');
        }
        
        async function createSession() {
            const sessionId = document.getElementById('sessionId').value;
            if (!sessionId) {
                showStatus('Please enter a session ID first', 'error');
                return;
            }
            
            try {
                showStatus('Creating session...', 'info');
                
                // Call backend to create session (this will connect WebSocket and create session)
                const result = await window.electronAPI.createSession(sessionId);
                
                if (!result.success) {
                    throw new Error(result.error || 'Failed to create session');
                }
                
                // Update UI
                document.getElementById('current-session-id').textContent = sessionId;
                document.getElementById('create-session-btn').classList.add('hidden');
                document.getElementById('end-session-btn').classList.remove('hidden');
                document.getElementById('session-panel').classList.remove('hidden');
                document.getElementById('websocket-status').classList.remove('hidden');
                document.getElementById('websocket-status').textContent = 'WebSocket: Connected';
                document.getElementById('websocket-status').className = 'status success';
                
                showStatus(`Session ${sessionId} created successfully`, 'success');
            } catch (error) {
                console.error('Failed to create session:', error);
                showStatus(`Failed to create session: ${error.message}`, 'error');
            }
        }
        
        function endSession() {
            document.getElementById('current-session-id').textContent = 'Not Connected';
            document.getElementById('client-count').textContent = '0';
            document.getElementById('create-session-btn').classList.remove('hidden');
            document.getElementById('end-session-btn').classList.add('hidden');
            document.getElementById('websocket-status').textContent = 'WebSocket: Disconnected';
            document.getElementById('websocket-status').className = 'status info';
            
            showStatus('Session ended', 'info');
        }
        
        // Cost tracking functions
        let costTracker = {
            transcribe: { cost: 0, minutes: 0 },
            translate: { cost: 0, characters: 0 },
            polly: { cost: 0, characters: 0 },
            total: 0,
            hourlyRate: 0,
            sessionStart: new Date()
        };
        
        function updateCostDisplay() {
            document.getElementById('transcribe-cost').textContent = `$${costTracker.transcribe.cost.toFixed(3)}`;
            document.getElementById('transcribe-usage').textContent = `${costTracker.transcribe.minutes.toFixed(1)} min`;
            
            document.getElementById('translate-cost').textContent = `$${costTracker.translate.cost.toFixed(3)}`;
            document.getElementById('translate-usage').textContent = `${costTracker.translate.characters} chars`;
            
            document.getElementById('polly-cost').textContent = `$${costTracker.polly.cost.toFixed(3)}`;
            document.getElementById('polly-usage').textContent = `${costTracker.polly.characters} chars`;
            
            document.getElementById('total-cost').textContent = `$${costTracker.total.toFixed(3)}`;
            document.getElementById('hourly-rate').textContent = `$${costTracker.hourlyRate.toFixed(2)}/hour`;
            
            // Show warning if hourly rate exceeds $3
            const warningElement = document.getElementById('cost-warning');
            if (costTracker.hourlyRate > 3.0) {
                warningElement.classList.remove('hidden');
                warningElement.textContent = `Cost rate of $${costTracker.hourlyRate.toFixed(2)}/hour exceeds $3/hour threshold!`;
            } else {
                warningElement.classList.add('hidden');
            }
        }
        
        function trackTranscribeUsage(minutes) {
            costTracker.transcribe.minutes += minutes;
            costTracker.transcribe.cost += minutes * 0.024; // $0.024 per minute
            updateTotalCost();
        }
        
        function trackTranslateUsage(characters) {
            costTracker.translate.characters += characters;
            costTracker.translate.cost += characters * (15 / 1000000); // $15 per 1M characters
            updateTotalCost();
        }
        
        function trackPollyUsage(characters, voiceType) {
            costTracker.polly.characters += characters;
            const rate = voiceType === 'neural' ? (16 / 1000000) : (4 / 1000000);
            costTracker.polly.cost += characters * rate;
            updateTotalCost();
        }
        
        function updateTotalCost() {
            costTracker.total = costTracker.transcribe.cost + costTracker.translate.cost + costTracker.polly.cost;
            
            // Calculate hourly rate
            const sessionHours = (new Date() - costTracker.sessionStart) / (1000 * 60 * 60);
            costTracker.hourlyRate = sessionHours > 0 ? costTracker.total / sessionHours : 0;
            
            updateCostDisplay();
        }
        
        function resetCostTracking() {
            costTracker = {
                transcribe: { cost: 0, minutes: 0 },
                translate: { cost: 0, characters: 0 },
                polly: { cost: 0, characters: 0 },
                total: 0,
                hourlyRate: 0,
                sessionStart: new Date()
            };
            updateCostDisplay();
        }

        // Handle transcription results
        window.electronAPI.onTranscription((result) => {
            const content = document.getElementById('tab-pt-BR');
            if (result.isPartial) {
                content.innerHTML = content.innerHTML.split('<br><em>')[0] + '<br><em>' + result.text + '</em>';
            } else {
                content.innerHTML = content.innerHTML.replace(/<br><em>.*<\/em>/, '') + '<br>' + result.text;
                
                // Track transcription usage for cost calculation
                if (result.text && result.text.trim()) {
                    const estimatedMinutes = result.text.split(' ').length / 150; // ~150 words per minute
                    trackTranscribeUsage(estimatedMinutes);
                }
            }
            content.scrollTop = content.scrollHeight;
        });

        // Handle translation results
        window.electronAPI.onTranslation((result) => {
            result.translations.forEach(translation => {
                const tabContent = document.getElementById(`tab-${translation.targetLanguage}`);
                if (tabContent) {
                    if (translation.isPartial) {
                        tabContent.innerHTML = tabContent.innerHTML.split('<br><em>')[0] + '<br><em>' + translation.text + '</em>';
                    } else {
                        tabContent.innerHTML = tabContent.innerHTML.replace(/<br><em>.*<\/em>/, '') + '<br>' + translation.text;
                    }
                    tabContent.scrollTop = tabContent.scrollHeight;
                }
            });
            
            // Track translation usage for cost calculation
            if (result.originalText && result.translations) {
                const totalCharacters = result.originalText.length * result.translations.length;
                trackTranslateUsage(totalCharacters);
            }
        });

        // Handle streaming errors
        window.electronAPI.onStreamingError((error) => {
            showStatus(`Streaming error: ${error.error}`, 'error');
        });

        // Handle audio level updates
        window.electronAPI.onAudioLevel((level) => {
            updateVUMeter(level);
        });

        // Handle cost tracking events
        window.electronAPI.onPollyUsage((usage) => {
            console.log('Polly usage event received:', usage);
            trackPollyUsage(usage.characters, usage.voiceType);
        });

        window.electronAPI.onCostsUpdated((costs) => {
            console.log('Costs updated event received:', costs);
            costTracker = { ...costTracker, ...costs };
            updateCostDisplay();
        });

        window.electronAPI.onCostAlert((alert) => {
            console.log('Cost alert event received:', alert);
            showStatus(`Cost Alert: ${alert.message}`, 'error');
        });

        // Handle WebSocket events
        window.electronAPI.onWebSocketConnected(() => {
            updateWebSocketStatus('connected');
        });

        window.electronAPI.onWebSocketDisconnected(() => {
            updateWebSocketStatus('disconnected');
        });

        window.electronAPI.onClientConnected((clientInfo) => {
            updateClientCount();
            updateLastActivity('Client connected');
        });

        window.electronAPI.onClientDisconnected((clientInfo) => {
            updateClientCount();
            updateLastActivity('Client disconnected');
        });

        // Holyrics control functions
        async function testHolyricsConnection() {
            try {
                const result = await window.electronAPI.testHolyricsConnection();
                if (result.success) {
                    showStatus('Holyrics connection successful!', 'success');
                } else {
                    showStatus('Holyrics connection failed', 'error');
                }
            } catch (error) {
                showStatus(`Holyrics test failed: ${error.message}`, 'error');
            }
        }

        async function clearHolyrics() {
            try {
                await window.electronAPI.clearHolyrics();
                showStatus('Holyrics screen cleared', 'success');
            } catch (error) {
                showStatus(`Failed to clear Holyrics: ${error.message}`, 'error');
            }
        }

        // Load Holyrics configuration
        function loadHolyricsConfig(config) {
            if (config.holyrics) {
                document.getElementById('holyricsEnabled').checked = config.holyrics.enabled || false;
                document.getElementById('holyricsHost').value = config.holyrics.host || 'localhost';
                document.getElementById('holyricsPort').value = config.holyrics.port || 8080;
                document.getElementById('holyricsToken').value = config.holyrics.token || '';
                document.getElementById('holyricsLanguage').value = config.holyrics.language || 'pt';
                document.getElementById('holyricsMaxLines').value = config.holyrics.maxLines || 3;
            }
        }

        // WebSocket Health Functions
        function updateWebSocketStatus(status) {
            const statusElement = document.getElementById('ws-server-status');
            if (status === 'connected') {
                statusElement.textContent = 'Connected';
                statusElement.style.color = '#4CAF50';
            } else {
                statusElement.textContent = 'Disconnected';
                statusElement.style.color = '#f44336';
            }
        }

        function updateClientCount() {
            // This would be updated from actual WebSocket events
            const count = document.getElementById('ws-client-count').textContent;
            // For now, just update the display
        }

        function updateLastActivity(activity) {
            const now = new Date();
            const timeStr = now.toLocaleTimeString();
            document.getElementById('ws-last-activity').textContent = `${activity} at ${timeStr}`;
        }

        function updateSessionId(sessionId) {
            document.getElementById('ws-session-id').textContent = sessionId || 'No Session';
        }
    </script>
</body>
</html>
